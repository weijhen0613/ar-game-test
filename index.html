<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Easter Egg Hunt</title>
  
  <script>
    window.onerror = function(message, source, lineno, colno, error) {
      const log = document.getElementById('error-log');
      if (log) {
        log.style.display = 'block';
        log.innerHTML += "âŒ " + message + "<br>";
      }
      alert("ç¨‹å¼å‡ºéŒ¯äº†: " + message); // æ‰‹æ©Ÿç›´æ¥å½ˆçª—é€šçŸ¥
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

  <style>
    body { margin: 0; background: #222; overflow: hidden; font-family: 'Fredoka One', cursive; }
    #game-container { position: relative; width: 100vw; height: 100vh; display: none; }
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0; }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: flex-start; }
    #score-board {
      margin-top: 15px; padding: 10px 25px; background: rgba(255, 248, 220, 0.8); backdrop-filter: blur(5px); border-radius: 30px;
      font-size: 24px; color: #d35400; border: 3px solid #f1c40f; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
    }
    
    /* éŒ¯èª¤é¡¯ç¤ºå€ (æœ€ä¸Šå±¤) */
    #error-log { 
      position: absolute; top: 0; left: 0; width: 100%; 
      background: rgba(200, 0, 0, 0.9); color: white; 
      font-size: 14px; padding: 10px; display: none; z-index: 9999; 
      white-space: pre-wrap; word-break: break-word;
    }
    
    #start-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #87CEEB; 
      background-image: url('./background.png'); 
      background-size: cover; 
      background-position: center;
      display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20;
    }

    .overlay { 
      background: rgba(255, 255, 255, 0.9); 
      padding: 30px 20px; 
      border-radius: 30px; 
      text-align: center; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
      width: 85%;      
      max-width: 400px; 
      margin: 0 auto;
    }
    
    h1 { color: #d35400; font-size: 36px; margin-bottom: 5px; text-shadow: 2px 2px 0px #f1c40f; line-height: 1.2; }
    
    .icon-guide { 
      font-size: 22px; 
      margin: 15px 0; 
      text-align: left; 
      display: inline-block; 
      line-height: 1.8; 
      color: #555;
    }

    #start-btn {
      background: linear-gradient(to bottom, #f1c40f, #f39c12); border: none; border-radius: 50px; padding: 12px 40px; color: white; font-size: 24px; font-family: 'Fredoka One', cursive; cursor: pointer; box-shadow: 0 6px 0 #d35400, 0 10px 10px rgba(0,0,0,0.2); transition: transform 0.1s, box-shadow 0.1s; margin-top: 15px;
    }
    #start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #d35400, 0 4px 4px rgba(0,0,0,0.2); }
    #start-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
  </style>
</head>
<body>

  <div id="error-log"></div>

  <div id="start-screen">
    <div class="overlay">
      <h1>EASTER EGG<br>HUNT</h1>
      
      <div class="icon-guide" style="font-size: 22px;">
        ğŸ–ï¸ Paper = Catch Egg (+10)<br>
        âœŠ Rock = Smash Rock (+5)<br>
        <span style="font-size: 14px; color: #e74c3c;">(Don't smash eggs!)</span>
      </div>
      
      <br>
      <button id="start-btn" onclick="startGame()">START</button>
    </div>
  </div>

  <div id="game-container">
    <video id="input_video" playsinline autoplay muted></video>
    <canvas id="output_canvas"></canvas>
    <div id="ui-layer"><div id="score-board">Loading...</div></div>
  </div>

<script>
  // è¼”åŠ©å‡½å¼ï¼šé¡¯ç¤ºéŒ¯èª¤
  function logError(msg) { 
    const log = document.getElementById('error-log');
    log.style.display = 'block'; 
    log.innerHTML += "âš ï¸ " + msg + "<br>"; 
    console.error(msg); 
  }

  // æª¢æŸ¥åœ–ç‰‡è¼‰å…¥ç‹€æ³
  function checkImage(img, name) {
    img.onload = () => console.log(name + " loaded");
    img.onerror = () => console.log(name + " failed to load");
  }

  const bgImg = new Image(); bgImg.src = './background.png'; checkImage(bgImg, "Background");
  const basketImg = new Image(); basketImg.src = './my_basket.png'; checkImage(basketImg, "Basket");
  const hammerImg = new Image(); hammerImg.src = './hammer.png'; checkImage(hammerImg, "Hammer");

  const eggFiles = ['./egg1.png', './egg2.png', './egg3.png'];
  const eggImages = [];
  eggFiles.forEach(src => { const img = new Image(); img.src = src; eggImages.push(img); });

  const rockFiles = ['./rock1.png', './rock2.png', './rock3.png'];
  const rockImages = [];
  rockFiles.forEach(src => { const img = new Image(); img.src = src; rockImages.push(img); });

  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const scoreBoard = document.getElementById('score-board');

  let score = 0;
  let gameObjects = []; 
  let lastSpawnTime = 0;
  let lastSpawnX = 0.5; 
  let basketPosition = { x: 0.5, y: 0.8 };
  let isBasketOpen = true; 
  let isGameRunning = false; 

  // === é—œéµä¿®æ­£ï¼šç¢ºä¿ Start å‡½å¼è¢«æ­£ç¢ºå®šç¾© ===
  window.startGame = function() {
    const btn = document.getElementById('start-btn');
    btn.innerText = "Starting..."; // æ”¹è®Šæ–‡å­—çµ¦å›é¥‹
    btn.disabled = true; // é˜²æ­¢é‡è¤‡é»æ“Š

    // æª¢æŸ¥æ˜¯å¦æ”¯æ´ç›¸æ©Ÿ
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      logError("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿï¼Œæˆ–ç¶²å€ä¸æ˜¯ https");
      alert("è«‹ç¢ºèªç¶²å€é–‹é ­æ˜¯ https://ï¼Œæˆ–æ›´æ›ç€è¦½å™¨ (Chrome/Safari)");
      return;
    }

    camera.start()
      .then(() => { 
        console.log("Camera started successfully");
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        isGameRunning = true; 
      })
      .catch(err => { 
        logError("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err); 
        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚");
        btn.innerText = "START";
        btn.disabled = false;
      });
  };

  function drawBackground(width, height) {
    canvasCtx.save();
    if (bgImg.complete && bgImg.naturalHeight !== 0) {
      canvasCtx.translate(width, 0); canvasCtx.scale(-1, 1);
      canvasCtx.drawImage(bgImg, 0, 0, width, height);
    }
    canvasCtx.restore();
  }
  
  function detectGesture(landmarks) {
    let fingersUp = 0;
    if (landmarks[8].y < landmarks[6].y) fingersUp++;
    if (landmarks[12].y < landmarks[10].y) fingersUp++;
    if (landmarks[16].y < landmarks[14].y) fingersUp++;
    if (landmarks[20].y < landmarks[18].y) fingersUp++;
    return (fingersUp >= 3) ? "PAPER" : "ROCK";
  }

  function updateGame(width, height) {
    if (!isGameRunning) return;

    const now = Date.now();
    if (now - lastSpawnTime > 1300) { 
      const type = Math.random() > 0.3 ? 'egg' : 'bomb'; 
      let newX = Math.random();
      for(let k=0; k<5; k++) { if (Math.abs(newX - lastSpawnX) > 0.35) { break; } newX = Math.random(); }
      lastSpawnX = newX; 
      const speed = 0.01 + Math.random() * 0.015; 
      
      let imgIdx = 0;
      if (type === 'egg') imgIdx = Math.floor(Math.random() * eggImages.length);
      else imgIdx = Math.floor(Math.random() * rockImages.length);

      gameObjects.push({ x: newX, y: -0.1, type: type, imgIdx: imgIdx, speed: speed, active: true });
      lastSpawnTime = now;
    }

    for (let i = 0; i < gameObjects.length; i++) {
      let obj = gameObjects[i];
      if (!obj.active) continue;
      obj.y += obj.speed;
      const screenX = obj.x * width; const screenY = obj.y * height;
      const baseSize = 80;

      canvasCtx.save(); canvasCtx.translate(screenX, screenY); canvasCtx.scale(-1, 1); 
      let imgToDraw = (obj.type === 'egg') ? eggImages[obj.imgIdx] : rockImages[obj.imgIdx];
      
      if (imgToDraw && imgToDraw.complete && imgToDraw.naturalHeight !== 0) {
          const ratio = imgToDraw.naturalHeight / imgToDraw.naturalWidth;
          canvasCtx.drawImage(imgToDraw, -baseSize/2, -(baseSize*ratio)/2, baseSize, baseSize*ratio);
      } else {
          canvasCtx.font = "60px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle";
          canvasCtx.fillText(obj.type === 'egg' ? "ğŸ¥š" : "ğŸª¨", 0, 0);
      }
      canvasCtx.restore(); 

      const distX = Math.abs(obj.x - basketPosition.x);
      const distY = Math.abs(obj.y - basketPosition.y);
      const hit = (distX < 0.12 && distY < 0.08);

      if (hit) {
        if (isBasketOpen) {
          if (obj.type === 'egg') {
            score += 10; showEffect(screenX, screenY, "+10", "#FFD700"); 
          } else {
            score -= 20; showEffect(screenX, screenY, "Ouch!", "#FF0000"); 
          }
        } else {
          if (obj.type === 'egg') {
            score -= 10; showEffect(screenX, screenY, "Broken!", "#FF0000"); 
          } else {
            score += 5; showEffect(screenX, screenY, "Smash!", "#00FF00"); 
          }
        }
        
        obj.active = false; 
        scoreBoard.innerText = "Score: " + score;
        scoreBoard.style.color = (score < 0) ? "red" : "#d35400";
      }

      if (obj.y > 1.1) obj.active = false;
    }
    gameObjects = gameObjects.filter(obj => obj.active);
  }

  let effects = [];
  function showEffect(x, y, text, color) { effects.push({x, y, text, color, life: 30}); }
  function drawEffects() {
    for (let i = 0; i < effects.length; i++) {
      let e = effects[i];
      if (e.life > 0) {
        canvasCtx.fillStyle = e.color; canvasCtx.strokeStyle = "white"; canvasCtx.lineWidth = 2; canvasCtx.font = "bold 40px Arial";
        canvasCtx.save(); canvasCtx.translate(e.x, e.y); canvasCtx.scale(-1, 1); 
        canvasCtx.strokeText(e.text, 0, 0); canvasCtx.fillText(e.text, 0, 0);
        canvasCtx.restore(); e.y -= 3; e.life--;
      }
    }
    effects = effects.filter(e => e.life > 0);
  }

  function onResults(results) {
    try {
      canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
      const w = canvasElement.width; const h = canvasElement.height;
      if (w === 0 || h === 0) return; 

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, w, h);
      canvasCtx.drawImage(results.image, 0, 0, w, h);
      drawBackground(w, h);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        const gesture = detectGesture(landmarks);
        isBasketOpen = (gesture === "PAPER"); 
        
        basketPosition.x = landmarks[9].x; basketPosition.y = landmarks[9].y;
        const pX = basketPosition.x * w; const pY = basketPosition.y * h;
        const size = 130; 

        canvasCtx.save(); canvasCtx.translate(pX, pY - 50); canvasCtx.scale(-1, 1); 
        
        if (isBasketOpen) {
          if (basketImg.complete && basketImg.naturalHeight !== 0) {
             const ratio = basketImg.naturalHeight / basketImg.naturalWidth;
             canvasCtx.drawImage(basketImg, -size/2, -(size*ratio)/2, size, size*ratio);
          } else {
             canvasCtx.font = "100px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle"; canvasCtx.fillText("ğŸ§º", 0, 0); 
          }
        } else {
          if (hammerImg.complete && hammerImg.naturalHeight !== 0) {
             const ratio = hammerImg.naturalHeight / hammerImg.naturalWidth;
             canvasCtx.drawImage(hammerImg, -size/2, -(size*ratio)/2, size, size*ratio);
          } else {
             canvasCtx.font = "100px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle"; canvasCtx.fillText("âœŠ", 0, 0); 
          }
        }
        canvasCtx.restore();
        
      } else {
         scoreBoard.innerText = "Show Your Hand";
      }

      updateGame(w, h);
      drawEffects();
      canvasCtx.restore();

    } catch (err) { logError(err.message); canvasCtx.restore(); }
  }

  const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
  hands.onResults(onResults);
  const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720, facingMode: 'user' });

</script>
</body>
</html>

