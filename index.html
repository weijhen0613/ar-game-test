<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>å¾©æ´»ç¯€æ¥å½©è›‹</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <style>
    body { margin: 0; background: #222; overflow: hidden; font-family: 'Arial', sans-serif; }
    .container { position: relative; width: 100vw; height: 100vh; }
    
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0; }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; display: flex; justify-content: center; align-items: flex-start; 
    }
    
    /* å¾©æ´»ç¯€ä¸»é¡Œçš„åˆ†æ•¸æ¿é¡è‰² */
    #score-board {
      margin-top: 15px; padding: 8px 20px; 
      background: rgba(255, 240, 200, 0.7); /* éµé»ƒè‰²èƒŒæ™¯ */
      backdrop-filter: blur(5px); border-radius: 20px;
      font-size: 20px; font-weight: bold; color: #d35400; /* æ·±æ©˜è‰²æ–‡å­— */
      border: 2px solid rgba(255,255,255,0.8); z-index: 10;
    }

    #error-log { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 0, 0, 0.8); color: white; font-size: 14px; padding: 10px; display: none; z-index: 999; }
  </style>
</head>
<body>

<div class="container">
  <video id="input_video" playsinline autoplay muted></video>
  <canvas id="output_canvas"></canvas>
  <div id="ui-layer"><div id="score-board">Loading...</div></div>
  <div id="error-log"></div>
</div>

<script>
  function logError(msg) { document.getElementById('error-log').style.display = 'block'; document.getElementById('error-log').innerText = "âš ï¸ " + msg; }

  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const scoreBoard = document.getElementById('score-board');

  // === éŠæˆ²è®Šæ•¸ ===
  let score = 0;
  let gameObjects = []; 
  let lastSpawnTime = 0;
  let lastSpawnX = 0.5; 
  let basketPosition = { x: 0.5, y: 0.8 };
  let isBasketOpen = true; 

  // === æ–°å¢ï¼šèƒŒæ™¯å…ƒç´  (å°é³¥) ===
  let backgroundElements = [];
  let isBgInitialized = false;

  // åˆå§‹åŒ–èƒŒæ™¯å°é³¥ (åªåŸ·è¡Œä¸€æ¬¡)
  function initBackgroundBirds(width, height) {
    const birdEmojis = ['ğŸ¦', 'ğŸ¤', 'ğŸ•Šï¸', 'ğŸ¦œ'];
    // åœ¨ç•«é¢ä¸Šéš¨æ©Ÿç”¢ç”Ÿ 8 éš»å°é³¥
    for (let i = 0; i < 8; i++) {
      backgroundElements.push({
        x: Math.random() * width,        // éš¨æ©Ÿæ°´å¹³ä½ç½®
        y: Math.random() * height * 0.6, // åªåˆ†ä½ˆåœ¨ç•«é¢ä¸ŠåŠéƒ¨ (å¤©ç©º)
        emoji: birdEmojis[Math.floor(Math.random() * birdEmojis.length)],
        size: 30 + Math.random() * 20,   // éš¨æ©Ÿå¤§å°
        rotation: (Math.random() - 0.5) * 0.5 // éš¨æ©Ÿä¸€é»é»å‚¾æ–œ
      });
    }
    isBgInitialized = true;
  }

  // ç¹ªè£½èƒŒæ™¯å°é³¥
  function drawBackground(width, height) {
    if (!isBgInitialized) initBackgroundBirds(width, height);

    canvasCtx.save();
    // å› ç‚ºèƒŒæ™¯ä¸éœ€è¦è·Ÿè‘—äººå‹•ï¼Œæˆ‘å€‘ä¸ç”¨æŠŠå®ƒå€‘é¡åƒç¿»è½‰ï¼Œç›´æ¥ç•«å°±å¥½
    // ä½†å¦‚æœå¸Œæœ›å®ƒå€‘è·Ÿè‘—é¡é ­æ–¹å‘ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢é€™è¡Œçš„è¨»è§£
    // canvasCtx.scale(-1, 1); canvasCtx.translate(-width, 0);

    backgroundElements.forEach(bgElem => {
      canvasCtx.font = `${bgElem.size}px Arial`;
      canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle";
      canvasCtx.fillStyle = "rgba(255, 255, 255, 0.8)"; // ç¨å¾®åŠé€æ˜ä¸€é»ï¼ŒåƒèƒŒæ™¯

      canvasCtx.save();
      canvasCtx.translate(bgElem.x, bgElem.y);
      canvasCtx.rotate(bgElem.rotation);
      canvasCtx.fillText(bgElem.emoji, 0, 0);
      canvasCtx.restore();
    });
    canvasCtx.restore();
  }
  
  // æ‰‹å‹¢åˆ¤æ–·
  function detectGesture(landmarks) {
    let fingersUp = 0;
    if (landmarks[8].y < landmarks[6].y) fingersUp++;
    if (landmarks[12].y < landmarks[10].y) fingersUp++;
    if (landmarks[16].y < landmarks[14].y) fingersUp++;
    if (landmarks[20].y < landmarks[18].y) fingersUp++;
    return (fingersUp >= 3) ? "PAPER" : "ROCK";
  }

  // === éŠæˆ²é‚è¼¯æ›´æ–° ===
  function updateGame(width, height) {
    const now = Date.now();
    if (now - lastSpawnTime > 800) { 
      // æ”¹æˆæ‰è½è›‹æˆ–ç‚¸å½ˆ
      const type = Math.random() > 0.3 ? 'egg' : 'bomb'; 
      let newX = Math.random();
      for(let k=0; k<3; k++) { if (Math.abs(newX - lastSpawnX) < 0.3) newX = Math.random(); else break; }
      lastSpawnX = newX; 
      const speed = 0.01 + Math.random() * 0.015; 
      gameObjects.push({ x: newX, y: -0.1, type: type, speed: speed, active: true });
      lastSpawnTime = now;
    }

    for (let i = 0; i < gameObjects.length; i++) {
      let obj = gameObjects[i];
      if (!obj.active) continue;
      obj.y += obj.speed;
      const screenX = obj.x * width; const screenY = obj.y * height;
      
      canvasCtx.font = "55px Arial"; 
      canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle";
      canvasCtx.save(); canvasCtx.translate(screenX, screenY); canvasCtx.scale(-1, 1); 
      
      // ç¹ªè£½è›‹æˆ–ç‚¸å½ˆ
      if (obj.type === 'egg') canvasCtx.fillText("ğŸ¥š", 0, 0); 
      else canvasCtx.fillText("ğŸ’£", 0, 0);
      
      canvasCtx.restore(); 

      if (isBasketOpen) {
        const distX = Math.abs(obj.x - basketPosition.x); const distY = Math.abs(obj.y - basketPosition.y);
        if (distX < 0.12 && distY < 0.08) {
          if (obj.type === 'egg') {
            score += 10; showEffect(screenX, screenY, "+10", "#FFD700"); // é‡‘è‰²ç‰¹æ•ˆ
          } else {
            score -= 20; showEffect(screenX, screenY, "-20", "#FF0000"); 
          }
          obj.active = false;
          scoreBoard.innerText = "Score: " + score;
          scoreBoard.style.color = (score < 0) ? "red" : "#d35400";

