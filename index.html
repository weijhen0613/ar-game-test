<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>æ‰‹å‹¢æ¥æ¥æ¨‚</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <style>
    body { margin: 0; background: #222; overflow: hidden; font-family: 'Arial', sans-serif; }
    .container { position: relative; width: 100vw; height: 100vh; }
    
    /* å½±ç‰‡å±¤ (éš±è—ï¼Œæˆ‘å€‘åªçœ‹ Canvas) */
    video { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      object-fit: cover; transform: scaleX(-1); opacity: 0;
    }
    
    /* ç•«å¸ƒå±¤ (é¡¯ç¤ºéŠæˆ²ç•«é¢) */
    canvas { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      object-fit: cover; transform: scaleX(-1); 
    }
    
    /* UI ä»‹é¢ (åˆ†æ•¸) - å¿…é ˆåå‘è½‰å›ä¾†å› ç‚º canvas è¢«ç¿»è½‰äº† */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex;
      justify-content: center;
    }
    
    #score-board {
      margin-top: 20px;
      padding: 10px 30px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 10;
    }
  </style>
</head>
<body>

<div class="container">
  <video id="input_video" playsinline autoplay muted></video>
  <canvas id="output_canvas"></canvas>
  
  <div id="ui-layer">
    <div id="score-board">Score: 0</div>
  </div>
</div>

<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const scoreBoard = document.getElementById('score-board');

  // === éŠæˆ²è®Šæ•¸ ===
  let score = 0;
  let gameObjects = []; // å­˜æ”¾æ‰è½ç‰©
  let lastSpawnTime = 0;
  let basketPosition = { x: 0.5, y: 0.8 }; // ç±ƒå­ä½ç½® (0.0 ~ 1.0)
  let isBasketOpen = true; // æ‰‹å‹¢ç‹€æ…‹
  
  // === æ‰‹å‹¢åˆ¤æ–· ===
  function detectGesture(landmarks) {
    let fingersUp = 0;
    // ç°¡å–®åˆ¤æ–·å››æ ¹æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´
    if (landmarks[8].y < landmarks[6].y) fingersUp++;
    if (landmarks[12].y < landmarks[10].y) fingersUp++;
    if (landmarks[16].y < landmarks[14].y) fingersUp++;
    if (landmarks[20].y < landmarks[18].y) fingersUp++;
    
    // å¦‚æœå¤§æ–¼ 3 æ ¹æ‰‹æŒ‡ä¼¸ç›´ -> å¸ƒ (ç±ƒå­æ‰“é–‹)
    if (fingersUp >= 3) return "PAPER";
    // å¦å‰‡ -> çŸ³é ­ (ç±ƒå­é—œé–‰)
    return "ROCK";
  }

  // === éŠæˆ²é‚è¼¯ ===
  function updateGame(width, height) {
    const now = Date.now();
    
    // 1. ç”Ÿæˆæ‰è½ç‰© (æ¯ 1 ç§’ä¸€é¡†)
    if (now - lastSpawnTime > 1000) {
      const type = Math.random() > 0.3 ? 'bird' : 'bomb'; // 70% æ˜¯é³¥
      gameObjects.push({
        x: Math.random(), // 0.0 ~ 1.0
        y: -0.1,          // å¾é ‚éƒ¨ä¸Šæ–¹é–‹å§‹
        type: type,
        speed: 0.005 + Math.random() * 0.005, // éš¨æ©Ÿé€Ÿåº¦
        active: true
      });
      lastSpawnTime = now;
    }

    // 2. æ›´æ–°èˆ‡ç¹ªè£½æ‰è½ç‰©
    for (let i = 0; i < gameObjects.length; i++) {
      let obj = gameObjects[i];
      if (!obj.active) continue;

      // ç§»å‹•
      obj.y += obj.speed;

      // ç¹ªè£½
      const screenX = obj.x * width;
      const screenY = obj.y * height;
      
      canvasCtx.font = "40px Arial";
      canvasCtx.textAlign = "center";
      canvasCtx.textBaseline = "middle";
      
      if (obj.type === 'bird') {
        canvasCtx.fillText("ğŸ¦", screenX, screenY);
      } else {
        canvasCtx.fillText("ğŸ’£", screenX, screenY);
      }

      // 3. ç¢°æ’åˆ¤å®š (æ¥ä½)
      // åªæœ‰ç•¶ã€Œç±ƒå­æ‰“é–‹ (Paper)ã€ä¸”ã€Œè·é›¢å¤ è¿‘ã€æ‰ç®—æ¥ä½
      if (isBasketOpen) {
        // è¨ˆç®—è·é›¢ (ç°¡å–®çš„åœ“å½¢åˆ¤å®š)
        const distX = Math.abs(obj.x - basketPosition.x);
        const distY = Math.abs(obj.y - basketPosition.y);
        
        // åˆ¤å®šç¯„åœ (æ ¹æ“šè¢å¹•æ¯”ä¾‹èª¿æ•´)
        if (distX < 0.1 && distY < 0.05) {
          if (obj.type === 'bird') {
            score += 10;
            showEffect(screenX, screenY, "+10", "green");
          } else {
            score -= 20;
            showEffect(screenX, screenY, "-20", "red");
          }
          obj.active = false; // æ¶ˆå¤±
          scoreBoard.innerText = "Score: " + score;
          
          // åˆ†æ•¸è®Šè‰²
          if(score < 0) scoreBoard.style.color = "red";
          else scoreBoard.style.color = "#333";
        }
      }

      // 4. è¶…å‡ºé‚Šç•Œç§»é™¤
      if (obj.y > 1.1) {
        obj.active = false;
      }
    }
    
    // æ¸…ç†ç„¡æ•ˆç‰©ä»¶
    gameObjects = gameObjects.filter(obj => obj.active);
  }

  // === ç‰¹æ•ˆæ–‡å­— (æš«æ™‚æ€§) ===
  let effects = [];
  function showEffect(x, y, text, color) {
    effects.push({x, y, text, color, life: 30});
  }
  function drawEffects() {
    for (let i = 0; i < effects.length; i++) {
      let e = effects[i];
      if (e.life > 0) {
        canvasCtx.fillStyle = e.color;
        canvasCtx.font = "bold 30px Arial";
        canvasCtx.fillText(e.text, e.x, e.y);
        e.y -= 2; // å¾€ä¸Šé£„
        e.life--;
      }
    }
    effects = effects.filter(e => e.life > 0);
  }

  // === MediaPipe ä¸»å¾ªç’° ===
  function onResults(results) {
    // 1. è¨­å®šç•«å¸ƒ
    canvasElement.width = videoElement.videoWidth;
    canvasElement.height = videoElement.videoHeight;
    const w = canvasElement.width;
    const h = canvasElement.height;

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, w, h);
    
    // 2. ç¹ªè£½èƒŒæ™¯å½±ç‰‡
    canvasCtx.drawImage(results.image, 0, 0, w, h);

    // 3. è™•ç†æ‰‹éƒ¨åµæ¸¬
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
      const landmarks = results.multiHandLandmarks[0]; // åªå–ç¬¬ä¸€éš»æ‰‹
      
      // ç¹ªè£½éª¨æ¶
      drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
      drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

      // å–å¾—æ‰‹å‹¢
      const gesture = detectGesture(landmarks);
      isBasketOpen = (gesture === "PAPER");

      // æ›´æ–°ç±ƒå­ä½ç½® (ä½¿ç”¨ä¸­æŒ‡æ ¹éƒ¨ landmarks[9] ä½œç‚ºä¸­å¿ƒ)
      basketPosition.x = landmarks[9].x;
      basketPosition.y = landmarks[9].y;

      // ç¹ªè£½ç±ƒå­ (è·Ÿéš¨æ‰‹éƒ¨)
      const basketX = basketPosition.x * w;
      const basketY = basketPosition.y * h;
      
      canvasCtx.font = "80px Arial";
      canvasCtx.textAlign = "center";
      canvasCtx.textBaseline = "middle";
      
      if (isBasketOpen) {
        canvasCtx.fillText("ğŸ§º", basketX, basketY - 50); // ç±ƒå­åœ¨æ‰‹ä¸Šæ–¹ä¸€é»
      } else {
        canvasCtx.fillText("ğŸ‘Š", basketX, basketY - 50); // æ¡æ‹³åœ–ç¤º
      }
    }

    // 4. åŸ·è¡ŒéŠæˆ²è¿´åœˆ
    updateGame(w, h);
    drawEffects();

    canvasCtx.restore();
  }

  // === å•Ÿå‹• ===
  const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });
  hands.onResults(onResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 1280, height: 720, facingMode: 'user'
  });
  camera.start();

</script>
</body>
</html>
