<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>å®¢è£½åŒ–å¾©æ´»ç¯€æ¥è›‹</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <style>
    body { margin: 0; background: #222; overflow: hidden; font-family: 'Arial', sans-serif; }
    .container { position: relative; width: 100vw; height: 100vh; }
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0; }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: flex-start; }
    #score-board {
      margin-top: 15px; padding: 10px 25px; background: rgba(255, 248, 220, 0.8); backdrop-filter: blur(5px); border-radius: 30px;
      font-size: 24px; font-weight: bold; color: #d35400; border: 3px solid #f1c40f; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
    }
    #error-log { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(200, 0, 0, 0.9); color: white; font-size: 16px; padding: 15px; display: none; z-index: 9999; }
  </style>
</head>
<body>

<div class="container">
  <video id="input_video" playsinline autoplay muted></video>
  <canvas id="output_canvas"></canvas>
  <div id="ui-layer"><div id="score-board">Loading Images...</div></div>
  <div id="error-log"></div>
</div>

<script>
  function logError(msg) { document.getElementById('error-log').style.display = 'block'; document.getElementById('error-log').innerText = "âš ï¸ " + msg; console.error(msg); }

  // === 1. åœ–ç‰‡é è¼‰å…¥ç³»çµ± ===
  // å®šç¾©æª”æ¡ˆè·¯å¾‘
  const bgBirdFiles = ['./bg_bird1.png', './bg_bird2.png', './bg_bird3.png'];
  const eggFiles = ['./egg1.png', './egg2.png', './egg3.png'];
  const basketFile = './my_basket.png';

  // å»ºç«‹åœ–ç‰‡ç‰©ä»¶å®¹å™¨
  const bgBirdImages = [];
  const eggImages = [];
  const basketImg = new Image();
  basketImg.src = basketFile;

  // è¼‰å…¥èƒŒæ™¯é³¥åœ–
  bgBirdFiles.forEach(src => {
    const img = new Image(); img.src = src;
    bgBirdImages.push(img);
  });
  // è¼‰å…¥é›è›‹åœ–
  eggFiles.forEach(src => {
    const img = new Image(); img.src = src;
    eggImages.push(img);
  });

  // === 2. åˆå§‹åŒ–èƒŒæ™¯å…ƒç´  ===
  const backgroundElements = [];
  for (let i = 0; i < 8; i++) { // ç”¢ç”Ÿ 8 éš»èƒŒæ™¯é³¥
    backgroundElements.push({
      x: Math.random(),        
      y: 0.7 + Math.random() * 0.25, // åœ°é¢å€åŸŸ
      // éš¨æ©Ÿåˆ†é…ä¸€å¼µèƒŒæ™¯é³¥åœ–ç‰‡çš„ã€Œç´¢å¼•ç·¨è™Ÿã€(0, 1, æˆ– 2)
      imgIndex: Math.floor(Math.random() * bgBirdImages.length),
      size: 50 + Math.random() * 30, // é³¥çš„å¤§å°
      rotation: (Math.random() - 0.5) * 0.3
    });
  }

  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const scoreBoard = document.getElementById('score-board');

  let score = 0;
  let gameObjects = []; 
  let lastSpawnTime = 0;
  let lastSpawnX = 0.5; 
  let basketPosition = { x: 0.5, y: 0.8 };
  let isBasketOpen = true; 

  // === ç¹ªè£½èƒŒæ™¯å‡½æ•¸ (ä½¿ç”¨åœ–ç‰‡) ===
  function drawBackground(width, height) {
    canvasCtx.save();
    backgroundElements.forEach(bgElem => {
      const x = bgElem.x * width;
      const y = bgElem.y * height;
      const size = bgElem.size;
      // å–å¾—å°æ‡‰çš„åœ–ç‰‡ç‰©ä»¶
      const img = bgBirdImages[bgElem.imgIndex];

      canvasCtx.save();
      canvasCtx.translate(x, y);
      canvasCtx.scale(-1, 1); // ç¿»è½‰å›ä¾†
      canvasCtx.rotate(bgElem.rotation);
      
      // å¦‚æœåœ–ç‰‡è®€å–æˆåŠŸï¼Œå°±ç•«åœ–
      if (img.complete && img.naturalHeight !== 0) {
        // drawImage(åœ–ç‰‡, xåç§», yåç§», å¯¬, é«˜) - åç§»ä¸€åŠæ˜¯ç‚ºäº†ç½®ä¸­
        canvasCtx.drawImage(img, -size/2, -size/2, size, size * (img.height/img.width));
      } else {
        // åœ–ç‰‡é‚„æ²’å¥½ï¼Œæš«æ™‚ç•«å€‹åœ“åœˆä»£æ›¿
        canvasCtx.beginPath(); canvasCtx.arc(0, 0, size/3, 0, 2 * Math.PI);
        canvasCtx.fillStyle = "rgba(255,255,255,0.5)"; canvasCtx.fill();
      }
      canvasCtx.restore();
    });
    canvasCtx.restore();
  }
  
  function detectGesture(landmarks) {
    let fingersUp = 0;
    if (landmarks[8].y < landmarks[6].y) fingersUp++;
    if (landmarks[12].y < landmarks[10].y) fingersUp++;
    if (landmarks[16].y < landmarks[14].y) fingersUp++;
    if (landmarks[20].y < landmarks[18].y) fingersUp++;
    return (fingersUp >= 3) ? "PAPER" : "ROCK";
  }

  // === éŠæˆ²é‚è¼¯ (åŠ å…¥å¤šç¨®è›‹) ===
  function updateGame(width, height) {
    const now = Date.now();
    if (now - lastSpawnTime > 800) { 
      const type = Math.random() > 0.3 ? 'egg' : 'bomb'; 
      let newX = Math.random();
      for(let k=0; k<3; k++) { if (Math.abs(newX - lastSpawnX) < 0.3) newX = Math.random(); else break; }
      lastSpawnX = newX; 
      const speed = 0.01 + Math.random() * 0.015; 
      
      // å¦‚æœæ˜¯è›‹ï¼Œéš¨æ©Ÿé¸ä¸€ç¨®è›‹çš„ç´¢å¼• (0, 1, æˆ– 2)
      let eggIdx = 0;
      if (type === 'egg') {
        eggIdx = Math.floor(Math.random() * eggImages.length);
      }

      gameObjects.push({ x: newX, y: -0.1, type: type, eggIdx: eggIdx, speed: speed, active: true });
      lastSpawnTime = now;
    }

    for (let i = 0; i < gameObjects.length; i++) {
      let obj = gameObjects[i];
      if (!obj.active) continue;
      obj.y += obj.speed;
      const screenX = obj.x * width; const screenY = obj.y * height;
      const itemSize = 80; // æ‰è½ç‰©å¤§å°

      canvasCtx.save(); 
      canvasCtx.translate(screenX, screenY); 
      canvasCtx.scale(-1, 1); 
      
      if (obj.type === 'egg') {
        // ç•«æŒ‡å®šçš„é›è›‹åœ–
        const img = eggImages[obj.eggIdx];
        if (img.complete) {
           canvasCtx.drawImage(img, -itemSize/2, -itemSize/2, itemSize, itemSize);
        } else {
           canvasCtx.font = "60px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle"; canvasCtx.fillText("ğŸ¥š", 0, 0);
        }
      } else {
        // ç•«ç‚¸å½ˆ (é‚„æ˜¯ Emoji)
        canvasCtx.font = "60px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle";
        canvasCtx.fillText("ğŸ’£", 0, 0);
      }
      canvasCtx.restore(); 

      // ç¢°æ’åˆ¤å®š
      if (isBasketOpen) {
        const distX = Math.abs(obj.x - basketPosition.x); const distY = Math.abs(obj.y - basketPosition.y);
        if (distX < 0.12 && distY < 0.08) {
          if (obj.type === 'egg') {
            score += 10; showEffect(screenX, screenY, "+10", "#FFD700");
          } else {
            score -= 20; showEffect(screenX, screenY, "-20", "#FF0000"); 
          }
          obj.active = false;
          scoreBoard.innerText = "Score: " + score;
          scoreBoard.style.color = (score < 0) ? "red" : "#d35400";
        }
      }
      if (obj.y > 1.1) obj.active = false;
    }
    gameObjects = gameObjects.filter(obj => obj.active);
  }

  let effects = [];
  function showEffect(x, y, text, color) { effects.push({x, y, text, color, life: 30}); }
  function drawEffects() {
    for (let i = 0; i < effects.length; i++) {
      let e = effects[i];
      if (e.life > 0) {
        canvasCtx.fillStyle = e.color; canvasCtx.strokeStyle = "white"; canvasCtx.lineWidth = 2; canvasCtx.font = "bold 45px Arial";
        canvasCtx.save(); canvasCtx.translate(e.x, e.y); canvasCtx.scale(-1, 1); 
        canvasCtx.strokeText(e.text, 0, 0); canvasCtx.fillText(e.text, 0, 0);
        canvasCtx.restore(); e.y -= 3; e.life--;
      }
    }
    effects = effects.filter(e => e.life > 0);
  }

  // === MediaPipe ä¸»å¾ªç’° ===
  function onResults(results) {
    try {
      canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
      const w = canvasElement.width; const h = canvasElement.height;
      if (w === 0 || h === 0) return; 

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, w, h);
      canvasCtx.drawImage(results.image, 0, 0, w, h);
      
      // ç¹ªè£½èƒŒæ™¯åœ–ç‰‡
      drawBackground(w, h);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        // è¨»è§£æ‰éª¨æ¶ç¹ªè£½ï¼Œè®“ç•«é¢æ›´ä¹¾æ·¨
        // drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
        
        const gesture = detectGesture(landmarks);
        isBasketOpen = (gesture === "PAPER");
        basketPosition.x = landmarks[9].x; basketPosition.y = landmarks[9].y;
        const basketX = basketPosition.x * w; const basketY = basketPosition.y * h;
        const basketSize = 130; // ç±ƒå­å¤§å°

        // === ç¹ªè£½ä½ çš„å®¢è£½åŒ–ç±ƒå­ ===
        canvasCtx.save(); 
        canvasCtx.translate(basketX, basketY - 50); 
        canvasCtx.scale(-1, 1); 
        
        if (isBasketOpen) {
          if (basketImg.complete) {
             // ç•«å‡ºä½ çš„ç±ƒå­åœ–ç‰‡
             canvasCtx.drawImage(basketImg, -basketSize/2, -basketSize/2, basketSize, basketSize * (basketImg.height/basketImg.width));
          } else {
             // å¦‚æœåœ–ç‰‡æ²’è®€åˆ°ï¼Œé¡¯ç¤º Emoji
             canvasCtx.font = "100px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle"; canvasCtx.fillText("ğŸ§º", 0, 0); 
          }
        } else {
          // æ¡æ‹³æ™‚é¡¯ç¤º Emoji
          canvasCtx.font = "100px Arial"; canvasCtx.textAlign = "center"; canvasCtx.textBaseline = "middle"; canvasCtx.fillText("ğŸ‘Š", 0, 0);
        }
        canvasCtx.restore();
      } else {
         scoreBoard.innerText = "è«‹æŠŠæ‰‹æ”¾åœ¨é¡é ­å‰";
      }

      updateGame(w, h);
      drawEffects();
      canvasCtx.restore();

    } catch (err) { logError(err.message); canvasCtx.restore(); }
  }

  const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
  hands.onResults(onResults);
  const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720, facingMode: 'user' });
  camera.start().then(() => { console.log("Camera started"); }).catch(err => { logError("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err); });

</script>
</body>
</html>

